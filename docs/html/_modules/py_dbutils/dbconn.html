
<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8" />
    <title>py_dbutils.dbconn &#8212; py-dbutils unknown documentation</title>
    <link rel="stylesheet" href="../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../_static/language_data.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for py_dbutils.dbconn</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">logging</span> <span class="k">as</span> <span class="nn">lg</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="c1"># import subprocess as commands</span>
<span class="c1"># import commands</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">sqlalchemy</span>

<span class="c1"># import migrate_utils</span>
<span class="n">lg</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">()</span>
<span class="n">logging</span> <span class="o">=</span> <span class="n">lg</span><span class="o">.</span><span class="n">getLogger</span><span class="p">()</span>
<span class="c1"># </span>
<span class="n">logging</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">lg</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>


<span class="c1"># Decorator function to log and time how long a function took to run</span>


<div class="viewcode-block" id="Connection"><a class="viewcode-back" href="../../api/py_dbutils.html#py_dbutils.dbconn.Connection">[docs]</a><span class="k">class</span> <span class="nc">Connection</span><span class="p">:</span>
    <span class="c1"># _conn = None this need to be instance</span>
    <span class="c1"># _cur = None</span>
    <span class="c1"># _password = None</span>
    <span class="c1"># _userid = None</span>
    <span class="c1"># _sslmode = None</span>
    <span class="c1"># _host = None</span>
    <span class="c1"># _port = 5432</span>
    <span class="c1"># _database_name = None</span>
    <span class="c1"># _commit = True</span>
    <span class="c1"># _dbtype = None</span>
    <span class="c1"># _db_url = None</span>
    <span class="c1"># last_row_count = 0</span>
    <span class="c1"># dbschema = None</span>
    <span class="c1"># _sqlalchemy_con = None this needs to be instance</span>
    <span class="c1"># _sqlalchemy_meta = None this needs to be instance</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dbschema</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">commit</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">userid</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">host</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="mi">5432</span><span class="p">,</span> <span class="n">database</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">dbtype</span><span class="o">=</span><span class="s1">&#39;POSTGRES&#39;</span><span class="p">,</span> <span class="n">appname</span><span class="o">=</span><span class="s1">&#39;py_dbutils&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Describe Method:</span>

<span class="sd">        Args:(self, dbschema=None, commit=True, password=None, userid=None, host=None, port=5432, database=None,</span>
<span class="sd">          table_name (str): String</span>

<span class="sd">        Returns:</span>
<span class="sd">          None: None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_commit</span> <span class="o">=</span> <span class="n">commit</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dbschema</span> <span class="o">=</span> <span class="n">dbschema</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">appname</span> <span class="o">=</span> <span class="n">appname</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_database_name</span> <span class="o">=</span> <span class="n">database</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_port</span> <span class="o">=</span> <span class="n">port</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_userid</span> <span class="o">=</span> <span class="n">userid</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_password</span> <span class="o">=</span> <span class="n">password</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_host</span> <span class="o">=</span> <span class="n">host</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_sslmode</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;DB Connecting To: </span><span class="si">{0}</span><span class="s2">:</span><span class="si">{1}</span><span class="s2">:</span><span class="si">{2}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_host</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_database_name</span><span class="p">,</span> <span class="n">dbtype</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dbtype</span> <span class="o">=</span> <span class="n">dbtype</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dbtype</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;POSTGRES&#39;</span><span class="p">,</span> <span class="s1">&#39;CITUS&#39;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_conn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_connect_postgres</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dbtype</span> <span class="o">==</span> <span class="s1">&#39;MSSQL&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_conn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_connect_mssql</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dbtype</span> <span class="o">==</span> <span class="s1">&#39;MYSQL&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_conn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_connect_mysql</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dbtype</span> <span class="o">==</span> <span class="s1">&#39;ORACLE&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_conn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_connect_oracle</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">url</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># db url</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;DB Connected To: </span><span class="si">{0}</span><span class="s2">:</span><span class="si">{1}</span><span class="s2">:</span><span class="si">{2}</span><span class="s2">:</span><span class="si">{3}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_host</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_database_name</span><span class="p">,</span> <span class="n">dbtype</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_userid</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_sqlalchemy_con</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_sqlalchemy_meta</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Describe Method:</span>

<span class="sd">        Args:(self):</span>
<span class="sd">          table_name (str): String</span>

<span class="sd">        Returns:</span>
<span class="sd">          None: None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_val</span><span class="p">,</span> <span class="n">exc_tb</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Describe Method:</span>

<span class="sd">        Args:(self, exc_type, exc_val, exc_tb):</span>
<span class="sd">          table_name (str): String</span>

<span class="sd">        Returns:</span>
<span class="sd">          None: None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="fm">__del__</span><span class="p">()</span>

<div class="viewcode-block" id="Connection.sqlalchemy_engine_close"><a class="viewcode-back" href="../../api/py_dbutils.html#py_dbutils.dbconn.Connection.sqlalchemy_engine_close">[docs]</a>    <span class="k">def</span> <span class="nf">sqlalchemy_engine_close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Describe Method:</span>

<span class="sd">        Args:(self):</span>
<span class="sd">          table_name (str): String</span>

<span class="sd">        Returns:</span>
<span class="sd">          None: None</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_sqlalchemy_con</span> <span class="o">=</span> <span class="kc">None</span></div>

    <span class="c1"># @migrate_utils.static_func.timer</span>
<div class="viewcode-block" id="Connection.connect_sqlalchemy"><a class="viewcode-back" href="../../api/py_dbutils.html#py_dbutils.dbconn.Connection.connect_sqlalchemy">[docs]</a>    <span class="k">def</span> <span class="nf">connect_sqlalchemy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">schema</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">db_type</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Describe Method:</span>

<span class="sd">        Args:(self, schema=None, db_type=None):</span>
<span class="sd">          table_name (str): String</span>

<span class="sd">        Returns:</span>
<span class="sd">          None: None</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># import pymssql</span>
        <span class="sd">&#39;&#39;&#39;Returns a connection and a metadata object&#39;&#39;&#39;</span>
        <span class="c1"># We connect with the help of the PostgreSQL URL</span>
        <span class="c1"># postgresql://federer:grandestslam@localhost:5432/tennis</span>

        <span class="k">if</span> <span class="n">db_type</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dbtype</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">db_type</span> <span class="o">=</span> <span class="s2">&quot;POSTGRES&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">db_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dbtype</span>
        <span class="k">if</span> <span class="n">schema</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">schema</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbschema</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sqlalchemy_con</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sqlalchemy_meta</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">schema</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>

            <span class="k">if</span> <span class="n">db_type</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;POSTGRES&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">url</span> <span class="o">=</span> <span class="s1">&#39;postgresql://</span><span class="si">{}</span><span class="s1">:</span><span class="si">{}</span><span class="s1">@</span><span class="si">{}</span><span class="s1">:</span><span class="si">{}</span><span class="s1">/</span><span class="si">{}</span><span class="s1">&#39;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">url</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_userid</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_password</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_host</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_port</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_database_name</span><span class="p">)</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sqlalchemy_con</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_sqlalchemy_con</span> <span class="o">=</span> <span class="n">sqlalchemy</span><span class="o">.</span><span class="n">create_engine</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">url</span><span class="p">,</span> <span class="n">client_encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">,</span>
                                                                    <span class="n">connect_args</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;application_name&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">appname</span><span class="p">},</span>
                                                                    <span class="n">pool_size</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span>
                                                                    <span class="n">isolation_level</span><span class="o">=</span><span class="s2">&quot;AUTOCOMMIT&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">db_type</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;MSSQL&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">url</span> <span class="o">=</span> <span class="s1">&#39;mssql+pymssql://</span><span class="si">{}</span><span class="s1">:</span><span class="si">{}</span><span class="s1">@</span><span class="si">{}</span><span class="s1">:</span><span class="si">{}</span><span class="s1">/</span><span class="si">{}</span><span class="s1">&#39;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">url</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_userid</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_password</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_host</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_port</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_database_name</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_sqlalchemy_con</span> <span class="o">=</span> <span class="n">sqlalchemy</span><span class="o">.</span><span class="n">create_engine</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">url</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">db_type</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;MYSQL&quot;</span><span class="p">:</span>
                <span class="c1"># &#39;mysql+pymysql://root:test@192.168.99.100:3306/mysql&#39;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">url</span> <span class="o">=</span> <span class="s2">&quot;mysql+pymysql://</span><span class="si">{}</span><span class="s2">:</span><span class="si">{}</span><span class="s2">@</span><span class="si">{}</span><span class="s2">:</span><span class="si">{}</span><span class="s2">/</span><span class="si">{}</span><span class="s2">?charset=utf8&quot;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">url</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_userid</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_password</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_host</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_port</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_database_name</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_sqlalchemy_con</span> <span class="o">=</span> <span class="n">sqlalchemy</span><span class="o">.</span><span class="n">create_engine</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">url</span><span class="p">)</span>

            <span class="c1"># con=self._connect_mssql()</span>
            <span class="c1"># The return value of create_engine() is our connection object</span>

            <span class="c1"># We then bind the connection to MetaData()</span>
            <span class="c1"># print(&#39;connecting schema:&#39;, schema)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sqlalchemy_meta</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">schema</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_sqlalchemy_meta</span><span class="p">[</span><span class="n">schema</span><span class="p">]</span> <span class="o">=</span> <span class="n">sqlalchemy</span><span class="o">.</span><span class="n">MetaData</span><span class="p">(</span><span class="n">bind</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_sqlalchemy_con</span><span class="p">,</span> <span class="n">schema</span><span class="o">=</span><span class="n">schema</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sqlalchemy_con</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sqlalchemy_meta</span><span class="p">[</span><span class="n">schema</span><span class="p">]</span></div>

<div class="viewcode-block" id="Connection.print_drop_tables"><a class="viewcode-back" href="../../api/py_dbutils.html#py_dbutils.dbconn.Connection.print_drop_tables">[docs]</a>    <span class="k">def</span> <span class="nf">print_drop_tables</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Describe Method:</span>

<span class="sd">        Args:(self):</span>
<span class="sd">          table_name (str): String</span>

<span class="sd">        Returns:</span>
<span class="sd">          None: None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">con</span><span class="p">,</span> <span class="n">meta</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">connect_sqlalchemy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dbschema</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dbtype</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">meta</span><span class="o">.</span><span class="n">tables</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="c1"># print(type(n), n, t.name)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;drop table if exists </span><span class="si">{}</span><span class="s2">.</span><span class="si">{}</span><span class="s2"> cascade;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dbschema</span><span class="p">,</span> <span class="n">t</span><span class="o">.</span><span class="n">name</span><span class="p">))</span></div>

<div class="viewcode-block" id="Connection.pandas_dump_table_csv"><a class="viewcode-back" href="../../api/py_dbutils.html#py_dbutils.dbconn.Connection.pandas_dump_table_csv">[docs]</a>    <span class="k">def</span> <span class="nf">pandas_dump_table_csv</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table_list</span><span class="p">,</span> <span class="n">folder</span><span class="p">,</span> <span class="n">chunksize</span><span class="o">=</span><span class="mi">100000</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Describe Method:</span>

<span class="sd">        Args:(self, table_list, folder, chunksize=100000):</span>
<span class="sd">          table_name (str): String</span>

<span class="sd">        Returns:</span>
<span class="sd">          None: None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># def get_pandas_frame(self, table_name,rows=None):</span>
        <span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>

        <span class="n">conn</span><span class="p">,</span> <span class="n">meta</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">connect_sqlalchemy</span><span class="p">()</span>

        <span class="c1"># z=db.get_pandas_frame(&#39;errorlog&#39;)</span>
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">table_list</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;dumping table &quot;</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbschema</span><span class="p">)</span>
            <span class="n">table</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">schema</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">z</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_sql_table</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="n">conn</span><span class="p">,</span> <span class="n">schema</span><span class="o">=</span><span class="n">schema</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">coerce_float</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">parse_dates</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                  <span class="n">columns</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">chunksize</span><span class="o">=</span><span class="n">chunksize</span><span class="p">)</span>
            <span class="c1"># with open(folder+&quot;/&quot;+t+&quot;.csv&quot;,&quot;wb&quot;) as f:</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">_</span><span class="si">{}</span><span class="s2">_</span><span class="si">{}</span><span class="s2">.csv&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_database_name</span><span class="p">,</span> <span class="n">schema</span><span class="p">,</span> <span class="n">table</span><span class="p">)</span>
            <span class="n">full_file_path</span> <span class="o">=</span> <span class="n">folder</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span> <span class="o">+</span> <span class="n">filename</span>
            <span class="c1"># print(type(z),filename)</span>
            <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">full_file_path</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">df</span> <span class="ow">in</span> <span class="n">z</span><span class="p">:</span>
                    <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>

                    <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="c1"># print(list(df.columns))</span>

                        <span class="n">df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">full_file_path</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Records Dumped: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">)))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">full_file_path</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Records Dumped: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span> <span class="o">*</span> <span class="n">chunksize</span><span class="p">))</span>  <span class="c1"># print(dir(df),type(df))</span></div>

<div class="viewcode-block" id="Connection.dump_tables_csv"><a class="viewcode-back" href="../../api/py_dbutils.html#py_dbutils.dbconn.Connection.dump_tables_csv">[docs]</a>    <span class="k">def</span> <span class="nf">dump_tables_csv</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table_list</span><span class="p">,</span> <span class="n">folder</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Describe Method:</span>

<span class="sd">        Args:(self, table_list, folder):</span>
<span class="sd">          table_name (str): String</span>

<span class="sd">        Returns:</span>
<span class="sd">          None: None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">csv</span>

        <span class="n">con</span><span class="p">,</span> <span class="n">meta</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">connect_sqlalchemy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dbschema</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dbtype</span><span class="p">)</span>
        <span class="c1"># print dir(meta.tables)</span>
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">table_list</span><span class="p">:</span>
            <span class="c1"># print(type(n), n, t.name)</span>
            <span class="n">table</span> <span class="o">=</span> <span class="n">sqlalchemy</span><span class="o">.</span><span class="n">Table</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">meta</span><span class="p">,</span> <span class="n">autoload</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">autoload_with</span><span class="o">=</span><span class="n">con</span><span class="p">)</span>
            <span class="n">select</span> <span class="o">=</span> <span class="n">sqlalchemy</span><span class="o">.</span><span class="n">sql</span><span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="n">table</span><span class="p">])</span><span class="o">.</span><span class="n">limit</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">con</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">select</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">folder</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span> <span class="o">+</span> <span class="n">t</span> <span class="o">+</span> <span class="s2">&quot;.csv&quot;</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">out</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">writer</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
                <span class="n">out</span><span class="o">.</span><span class="n">writerow</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
                <span class="n">out</span><span class="o">.</span><span class="n">writerow</span><span class="p">(</span><span class="n">result</span><span class="p">)</span></div>

<div class="viewcode-block" id="Connection.get_schema_col_stats"><a class="viewcode-back" href="../../api/py_dbutils.html#py_dbutils.dbconn.Connection.get_schema_col_stats">[docs]</a>    <span class="k">def</span> <span class="nf">get_schema_col_stats</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">schema</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Describe Method:</span>

<span class="sd">        Args:(self, schema=None):</span>
<span class="sd">          table_name (str): String</span>

<span class="sd">        Returns:</span>
<span class="sd">          None: None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">v_schema</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbschema</span> <span class="k">if</span> <span class="n">schema</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">schema</span>
        <span class="n">sql</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;select  schemaname,tablename,attname as columnname,n_distinct , reltuples::bigint</span>
<span class="s2">            ,( (select   distinct(True)  from pg_index ix,pg_attribute ab where  ab.attnum = ANY(ix.indkey)</span>
<span class="s2">            and ab.attrelid = a.oid</span>
<span class="s2">            and ix.indrelid=a.oid</span>
<span class="s2">            and ab.attname=p.attname    )   )as is_index</span>
<span class="s2">            from pg_stats p,</span>
<span class="s2">            pg_class a</span>
<span class="s2">            where</span>
<span class="s2">            a.oid=concat(schemaname,&#39;.&#39;,tablename)::regclass and</span>
<span class="s2">            a.relkind=&#39;r&#39; and</span>
<span class="s2">            a.relname=tablename and</span>
<span class="s2">            schemaname=&#39;</span><span class="si">{}</span><span class="s2">&#39; and</span>
<span class="s2">            n_distinct&gt;0 order by 5,4;</span>
<span class="s2">            &quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">v_schema</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span></div>

<div class="viewcode-block" id="Connection.get_schema_index"><a class="viewcode-back" href="../../api/py_dbutils.html#py_dbutils.dbconn.Connection.get_schema_index">[docs]</a>    <span class="k">def</span> <span class="nf">get_schema_index</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">schema</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Describe Method:</span>

<span class="sd">        Args:(self, schema=None):</span>
<span class="sd">          table_name (str): String</span>

<span class="sd">        Returns:</span>
<span class="sd">          None: None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">pprint</span>

        <span class="n">v_schema</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbschema</span> <span class="k">if</span> <span class="n">schema</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">schema</span>

        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;select</span>
<span class="s2">    ns.nspname,</span>
<span class="s2">    t.relname as table_name,</span>
<span class="s2">    i.relname as index_name,</span>
<span class="s2">    array_to_string(array_agg(  a.attname), &#39;, &#39;) as column_names,</span>
<span class="s2">    ix.indisprimary as is_primarykey</span>
<span class="s2">from</span>
<span class="s2">    pg_namespace ns,</span>
<span class="s2">    pg_class t,</span>
<span class="s2">    pg_class i,</span>
<span class="s2">    pg_index ix,</span>
<span class="s2">    pg_attribute a</span>
<span class="s2">where</span>
<span class="s2">    ns.oid=t.relnamespace</span>
<span class="s2">    and t.oid = ix.indrelid</span>
<span class="s2">    and i.oid = ix.indexrelid</span>
<span class="s2">    and a.attrelid = t.oid</span>
<span class="s2">    and a.attnum = ANY(ix.indkey)</span>
<span class="s2">    and t.relkind = &#39;r&#39;</span>
<span class="s2">    -- and t.relname like &#39;test%&#39;</span>
<span class="s2">    and nspname=&#39;</span><span class="si">{}</span><span class="s2">&#39;</span>
<span class="s2">group by</span>
<span class="s2">    t.relname,</span>
<span class="s2">    i.relname,</span>
<span class="s2">    ns.nspname,</span>

<span class="s2">    ix.indisprimary</span>
<span class="s2">order by</span>
<span class="s2">    t.relname,</span>
<span class="s2">    i.relname;&quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">v_schema</span><span class="p">)))</span></div>

<div class="viewcode-block" id="Connection.get_create_table_sqlalchemy"><a class="viewcode-back" href="../../api/py_dbutils.html#py_dbutils.dbconn.Connection.get_create_table_sqlalchemy">[docs]</a>    <span class="k">def</span> <span class="nf">get_create_table_sqlalchemy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table_name</span><span class="p">,</span> <span class="n">trg_db</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Takes a query string and runs it to see if it returns any rows</span>

<span class="sd">        Args:</span>
<span class="sd">          table_name (str): String</span>

<span class="sd">        Returns:</span>
<span class="sd">          boolean: True/False</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">create_cur</span><span class="p">()</span>
        <span class="n">stmt</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">con</span><span class="p">,</span> <span class="n">meta</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">connect_sqlalchemy</span><span class="p">()</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">table_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="n">table</span> <span class="o">=</span> <span class="n">sqlalchemy</span><span class="o">.</span><span class="n">Table</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">meta</span><span class="p">,</span> <span class="n">autoload</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">autoload_with</span><span class="o">=</span><span class="n">con</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;xxxxx &quot;</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="n">table</span><span class="p">))</span>
        <span class="n">trg_con</span><span class="p">,</span> <span class="n">trg_meta</span> <span class="o">=</span> <span class="n">trg_db</span><span class="o">.</span><span class="n">connect_sqlalchemy</span><span class="p">()</span>
        <span class="n">stmt</span> <span class="o">=</span> <span class="n">sqlalchemy</span><span class="o">.</span><span class="n">schema</span><span class="o">.</span><span class="n">CreateTable</span><span class="p">(</span><span class="n">table</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="n">stmt</span><span class="p">,</span> <span class="s1">&#39;xxx&#39;</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">stmt</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
        <span class="k">return</span> <span class="n">stmt</span></div>

<div class="viewcode-block" id="Connection.print_tables"><a class="viewcode-back" href="../../api/py_dbutils.html#py_dbutils.dbconn.Connection.print_tables">[docs]</a>    <span class="k">def</span> <span class="nf">print_tables</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table_list</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Takes a query string and runs it to see if it returns any rows</span>

<span class="sd">        Args:</span>
<span class="sd">          table_name (str): String</span>

<span class="sd">        Returns:</span>
<span class="sd">          boolean: True/False</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">create_cur</span><span class="p">()</span>

        <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dbschema</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dbtype</span><span class="p">)</span>
        <span class="n">con</span><span class="p">,</span> <span class="n">meta</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">connect_sqlalchemy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dbschema</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dbtype</span><span class="p">)</span>
        <span class="c1"># print dir(meta.tables)</span>
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">table_list</span><span class="p">:</span>
            <span class="c1"># print(type(n), n, t.name)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">table</span> <span class="o">=</span> <span class="n">sqlalchemy</span><span class="o">.</span><span class="n">Table</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">meta</span><span class="p">,</span> <span class="n">autoload</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">autoload_with</span><span class="o">=</span><span class="n">con</span><span class="p">)</span>
                <span class="n">stmt</span> <span class="o">=</span> <span class="n">sqlalchemy</span><span class="o">.</span><span class="n">schema</span><span class="o">.</span><span class="n">CreateTable</span><span class="p">(</span><span class="n">table</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">stmt</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;;&quot;</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="c1"># print(&quot;Cannot Find Table: {}&quot;.format(t))</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Cannot Find Table: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">t</span><span class="p">))</span></div>

<div class="viewcode-block" id="Connection.get_create_table"><a class="viewcode-back" href="../../api/py_dbutils.html#py_dbutils.dbconn.Connection.get_create_table">[docs]</a>    <span class="k">def</span> <span class="nf">get_create_table</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Describe Method:</span>

<span class="sd">        Args:(self, table_name):</span>
<span class="sd">          table_name (str): String</span>

<span class="sd">        Returns:</span>
<span class="sd">          None: None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">sql</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;SELECT</span>
<span class="s2">  &#39;CREATE TABLE &#39; || relname || E&#39;</span><span class="se">\n</span><span class="s2">(</span><span class="se">\n</span><span class="s2">&#39; ||</span>
<span class="s2">  array_to_string(</span>
<span class="s2">    array_agg(</span>
<span class="s2">      &#39;    &#39; || column_name || &#39; &#39; ||  type || &#39; &#39;|| not_null</span>
<span class="s2">    )</span>
<span class="s2">    , E&#39;,</span><span class="se">\n</span><span class="s2">&#39;</span>
<span class="s2">  ) || E&#39;</span><span class="se">\n</span><span class="s2">);</span><span class="se">\n</span><span class="s2">&#39;</span>
<span class="s2">from</span>
<span class="s2">(</span>
<span class="s2">  SELECT</span>
<span class="s2">    c.relname, a.attname AS column_name,</span>
<span class="s2">    pg_catalog.format_type(a.atttypid, a.atttypmod) as type,</span>
<span class="s2">    case</span>
<span class="s2">      when a.attnotnull</span>
<span class="s2">    then &#39;NOT NULL&#39;</span>
<span class="s2">    else &#39;NULL&#39;</span>
<span class="s2">    END as not_null</span>
<span class="s2">  FROM pg_class c,</span>
<span class="s2">   pg_attribute a,</span>
<span class="s2">   pg_type t</span>
<span class="s2">   WHERE c.relname = </span><span class="si">{table_name}</span><span class="s2"></span>
<span class="s2">   AND a.attnum &gt; 0</span>
<span class="s2">   AND a.attrelid = c.oid</span>
<span class="s2">   AND a.atttypid = t.oid</span>
<span class="s2"> ORDER BY a.attnum</span>
<span class="s2">) as tabledefinition</span>
<span class="s2">group by relname;&quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">table_name</span><span class="p">)</span>
        <span class="n">create_sql</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_a_value</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">create_sql</span></div>

<div class="viewcode-block" id="Connection.get_create_table_via_dump"><a class="viewcode-back" href="../../api/py_dbutils.html#py_dbutils.dbconn.Connection.get_create_table_via_dump">[docs]</a>    <span class="k">def</span> <span class="nf">get_create_table_via_dump</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table_name</span><span class="p">,</span> <span class="n">target_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">gen_pk</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">gen_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">gen_fk</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Describe Method:</span>

<span class="sd">        Args:(self, table_name, target_name=None, gen_pk=True, gen_index=True, gen_fk=True):</span>
<span class="sd">          table_name (str): String</span>

<span class="sd">        Returns:</span>
<span class="sd">          None: None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">v_source_schema</span> <span class="o">=</span> <span class="n">table_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">v_target_schema</span> <span class="o">=</span> <span class="n">target_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">target_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">target_name</span> <span class="o">=</span> <span class="n">table_name</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_save_environment_vars</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_replace_environment_vars</span><span class="p">()</span>

        <span class="n">cli</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;pg_dump -st </span><span class="si">{}</span><span class="s2"> </span><span class="si">{}</span><span class="s2">&quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">table_name</span><span class="p">,</span> <span class="n">v_source_schema</span><span class="p">)</span>

        <span class="n">sql</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

        <span class="n">bash_error_code</span><span class="p">,</span> <span class="n">txt_out</span> <span class="o">=</span> <span class="n">commands</span><span class="o">.</span><span class="n">getstatusoutput</span><span class="p">(</span><span class="n">cli</span><span class="p">)</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="n">txt_out</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">line_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">txt_out</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">txt_out</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">lines</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;--&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">line</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">):</span>
                <span class="n">line_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
        <span class="n">lines2</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">line_list</span><span class="p">)</span>
        <span class="n">lines2</span> <span class="o">=</span> <span class="n">lines2</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">lines2</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_restore_environment_vars</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">v_index_sql</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="n">v_index_sql</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="n">sql</span><span class="p">,</span> <span class="n">v_index_sql</span></div>

<div class="viewcode-block" id="Connection.get_create_table_cli"><a class="viewcode-back" href="../../api/py_dbutils.html#py_dbutils.dbconn.Connection.get_create_table_cli">[docs]</a>    <span class="k">def</span> <span class="nf">get_create_table_cli</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table_name</span><span class="p">,</span> <span class="n">target_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">gen_pk</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">gen_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">gen_fk</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Takes a query string and runs it to see if it returns any rows</span>

<span class="sd">        Args:</span>
<span class="sd">          table_name (str): String</span>

<span class="sd">        Returns:</span>
<span class="sd">          boolean: True/False</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">create_cur</span><span class="p">()</span>
        <span class="n">v_source_schema</span> <span class="o">=</span> <span class="n">table_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">v_target_schema</span> <span class="o">=</span> <span class="n">target_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">target_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">target_name</span> <span class="o">=</span> <span class="n">table_name</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_save_environment_vars</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_replace_environment_vars</span><span class="p">()</span>

        <span class="n">cli</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;psql -c&quot;\d </span><span class="si">{}</span><span class="s2">&quot; &quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">table_name</span><span class="p">)</span>
        <span class="c1"># cli = &quot;&quot;&quot;psql {6} -c &quot;\copy {0} FROM &#39;{1}&#39; with (format csv,{4} FORCE_NULL ({3}),delimiter &#39;{2}&#39;, ENCODING &#39;{5}&#39;)&quot; &quot;&quot;&quot;</span>

        <span class="n">sql</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="n">v_index_sql</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="n">bash_error_code</span><span class="p">,</span> <span class="n">txt_out</span> <span class="o">=</span> <span class="n">commands</span><span class="o">.</span><span class="n">getstatusoutput</span><span class="p">(</span><span class="n">cli</span><span class="p">)</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="n">txt_out</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">v_index</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">txt_out</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">txt_out</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">lines</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">sql</span> <span class="o">+=</span> <span class="s2">&quot;Create table </span><span class="si">{}</span><span class="s2">(&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">target_name</span><span class="p">)</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">line</span> <span class="o">==</span> <span class="s1">&#39;Indexes:&#39;</span> <span class="ow">or</span> <span class="n">line</span> <span class="o">==</span> <span class="s1">&#39;Foreign-key constraints:&#39;</span> <span class="ow">or</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;Options:&#39;</span><span class="p">)</span> <span class="ow">or</span>
                  <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;Referenced by:&#39;</span><span class="p">)):</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">v_index</span><span class="p">:</span>
                    <span class="n">sql</span> <span class="o">+=</span> <span class="s1">&#39;); &#39;</span>
                <span class="n">v_index</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">elif</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">2</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">v_index</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">x</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;|&#39;</span><span class="p">)</span>
                <span class="n">v_default</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">v_default</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="n">x</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                    <span class="n">sql</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="n">x</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">sql</span> <span class="o">+=</span> <span class="s1">&#39;,</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="n">x</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                <span class="n">sql</span> <span class="o">+=</span> <span class="n">v_default</span>

            <span class="k">elif</span> <span class="n">v_index</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="s1">&#39;PRIMARY KEY&#39;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">gen_pk</span><span class="p">:</span>
                    <span class="n">v_index_sql</span> <span class="o">+=</span> <span class="s1">&#39;ALTER TABLE </span><span class="si">{0}</span><span class="s1"> ADD PRIMARY KEY (&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">target_name</span><span class="p">)</span>
                    <span class="n">v_index_sql</span> <span class="o">+=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;(&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;;</span><span class="se">\n</span><span class="s1">&#39;</span>

            <span class="k">elif</span> <span class="n">v_index</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="s1">&#39;FOREIGN KEY&#39;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">gen_fk</span><span class="p">:</span>

                    <span class="k">if</span> <span class="s1">&#39;REFERENCES&#39;</span> <span class="ow">in</span> <span class="n">line</span> <span class="ow">and</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;TABLE &#39;</span><span class="p">):</span>
                        <span class="n">v_referenced_table</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;&quot;&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
                        <span class="n">v_index_sql</span> <span class="o">+=</span> <span class="s1">&#39;ALTER TABLE </span><span class="si">{0}</span><span class="s1"> ADD CONSTRAINT FOREIGN KEY (&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">v_referenced_table</span><span class="p">)</span>
                        <span class="n">v_index_sql</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;(&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">v_source_schema</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span><span class="p">,</span>
                                                                               <span class="n">v_target_schema</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">v_index_sql</span> <span class="o">+=</span> <span class="s1">&#39;ALTER TABLE </span><span class="si">{0}</span><span class="s1"> ADD CONSTRAINT FOREIGN KEY (&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">target_name</span><span class="p">)</span>
                        <span class="n">v_index_sql</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;(&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">v_source_schema</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span><span class="p">,</span>
                                                                               <span class="n">v_target_schema</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">v_index</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="s1">&#39;UNIQUE&#39;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">gen_index</span><span class="p">:</span>
                    <span class="n">v_index_sql</span> <span class="o">+=</span> <span class="s1">&#39;CREATE UNIQUE INDEX  ON </span><span class="si">{0}</span><span class="s1"> (&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">target_name</span><span class="p">)</span>
                    <span class="n">v_index_sql</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;(&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">v_index</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="s1">&#39;btree&#39;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">gen_index</span><span class="p">:</span>
                    <span class="n">v_index_sql</span> <span class="o">+=</span> <span class="s1">&#39;CREATE INDEX  ON </span><span class="si">{0}</span><span class="s1"> &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">target_name</span><span class="p">)</span>
                    <span class="n">v_index_sql</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;btree&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">line</span> <span class="o">==</span> <span class="s1">&#39;Triggers:&#39;</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">5</span> <span class="ow">and</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;get_create_table_cli - Unknown Line: </span><span class="si">{0}</span><span class="s2">:</span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">line</span><span class="p">))</span>

            <span class="c1"># if no index where ever found close the bracket</span>
        <span class="k">if</span> <span class="n">v_index</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
            <span class="n">sql</span> <span class="o">+=</span> <span class="s1">&#39;);&#39;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_restore_environment_vars</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">v_index_sql</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="n">v_index_sql</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="n">sql</span><span class="p">,</span> <span class="n">v_index_sql</span></div>

<div class="viewcode-block" id="Connection.print_create_table"><a class="viewcode-back" href="../../api/py_dbutils.html#py_dbutils.dbconn.Connection.print_create_table">[docs]</a>    <span class="k">def</span> <span class="nf">print_create_table</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">folder</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Takes a query string and runs it to see if it returns any rows</span>

<span class="sd">        Args:</span>
<span class="sd">          table_name (str): String</span>

<span class="sd">        Returns:</span>
<span class="sd">          boolean: True/False</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">create_cur</span><span class="p">()</span>

        <span class="n">con</span><span class="p">,</span> <span class="n">meta</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">connect_sqlalchemy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dbschema</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dbtype</span><span class="p">)</span>
        <span class="c1"># print dir(meta.tables)</span>
        <span class="n">table_count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">meta</span><span class="o">.</span><span class="n">tables</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">table_count</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="c1"># print(type(n), n, t.name)</span>
            <span class="n">table</span> <span class="o">=</span> <span class="n">sqlalchemy</span><span class="o">.</span><span class="n">Table</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">meta</span><span class="p">,</span> <span class="n">autoload</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">autoload_with</span><span class="o">=</span><span class="n">con</span><span class="p">)</span>
            <span class="n">stmt</span> <span class="o">=</span> <span class="n">sqlalchemy</span><span class="o">.</span><span class="n">schema</span><span class="o">.</span><span class="n">CreateTable</span><span class="p">(</span><span class="n">table</span><span class="p">)</span>
            <span class="n">column_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">table</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
            <span class="n">createsql</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">stmt</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">folder</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">createsql</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;;&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">folder</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span> <span class="o">+</span> <span class="n">t</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;.sql&quot;</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">createsql</span> <span class="o">+</span> <span class="s2">&quot;;&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Total Tables:</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">table_count</span><span class="p">))</span></div>

<div class="viewcode-block" id="Connection.get_table_column_types"><a class="viewcode-back" href="../../api/py_dbutils.html#py_dbutils.dbconn.Connection.get_table_column_types">[docs]</a>    <span class="k">def</span> <span class="nf">get_table_column_types</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table_name</span><span class="p">,</span> <span class="n">trg_schema</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Takes a query string and runs it to see if it returns any rows</span>

<span class="sd">        Args:</span>
<span class="sd">          table_name (str): String</span>

<span class="sd">        Returns:</span>
<span class="sd">          boolean: True/False</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">create_cur</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">trg_schema</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">schema</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbschema</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">schema</span> <span class="o">=</span> <span class="n">trg_schema</span>
        <span class="n">con</span><span class="p">,</span> <span class="n">meta</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">connect_sqlalchemy</span><span class="p">()</span>
        <span class="n">table</span> <span class="o">=</span> <span class="n">sqlalchemy</span><span class="o">.</span><span class="n">Table</span><span class="p">(</span><span class="n">table_name</span><span class="p">,</span> <span class="n">meta</span><span class="p">,</span> <span class="n">schema</span><span class="o">=</span><span class="n">schema</span><span class="p">,</span> <span class="n">autoload</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">autoload_with</span><span class="o">=</span><span class="n">con</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">table</span><span class="o">.</span><span class="n">columns</span></div>

<div class="viewcode-block" id="Connection.get_table_columns"><a class="viewcode-back" href="../../api/py_dbutils.html#py_dbutils.dbconn.Connection.get_table_columns">[docs]</a>    <span class="k">def</span> <span class="nf">get_table_columns</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table_name</span><span class="p">,</span> <span class="n">trg_schema</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Takes a query string and runs it to see if it returns any rows</span>

<span class="sd">        Args:</span>
<span class="sd">          table_name (str): String</span>

<span class="sd">        Returns:</span>
<span class="sd">          boolean: True/False</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">create_cur</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">trg_schema</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">schema</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbschema</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">schema</span> <span class="o">=</span> <span class="n">trg_schema</span>
        <span class="n">con</span><span class="p">,</span> <span class="n">meta</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">connect_sqlalchemy</span><span class="p">()</span>
        <span class="n">table</span> <span class="o">=</span> <span class="n">sqlalchemy</span><span class="o">.</span><span class="n">Table</span><span class="p">(</span><span class="n">table_name</span><span class="p">,</span> <span class="n">meta</span><span class="p">,</span> <span class="n">schema</span><span class="o">=</span><span class="n">schema</span><span class="p">,</span> <span class="n">autoload</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">autoload_with</span><span class="o">=</span><span class="n">con</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">[</span><span class="n">c</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">table</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span></div>

<div class="viewcode-block" id="Connection.schema_exists"><a class="viewcode-back" href="../../api/py_dbutils.html#py_dbutils.dbconn.Connection.schema_exists">[docs]</a>    <span class="k">def</span> <span class="nf">schema_exists</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">schema_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Takes a query string and runs it to see if it returns any rows</span>

<span class="sd">        Args:</span>
<span class="sd">          table_name (str): String</span>

<span class="sd">        Returns:</span>
<span class="sd">          boolean: True/False</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">create_cur</span><span class="p">()</span>
        <span class="n">v_found</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="n">v_found</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_record</span><span class="p">(</span>
            <span class="sd">&quot;&quot;&quot;select 1 from information_schema.schemata where schema_name=&#39;{0}&#39; limit 1&quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">schema_name</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">v_found</span></div>

<div class="viewcode-block" id="Connection.table_exists"><a class="viewcode-back" href="../../api/py_dbutils.html#py_dbutils.dbconn.Connection.table_exists">[docs]</a>    <span class="k">def</span> <span class="nf">table_exists</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Takes a query string and runs it to see if it returns any rows</span>

<span class="sd">        Args:</span>
<span class="sd">          table_name (str): String</span>

<span class="sd">        Returns:</span>
<span class="sd">          boolean: True/False</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">create_cur</span><span class="p">()</span>

        <span class="n">v_table_exists</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">v_schema</span> <span class="o">=</span> <span class="n">table_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">v_table_name</span> <span class="o">=</span> <span class="n">table_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">v_table_exists</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_record</span><span class="p">(</span>
            <span class="sd">&quot;&quot;&quot;select 1 from information_schema.tables where table_schema=&#39;{0}&#39; and table_name=&#39;{1}&#39;&quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">v_schema</span><span class="p">,</span>
                                                                                                               <span class="n">v_table_name</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">v_table_exists</span></div>

<div class="viewcode-block" id="Connection.has_record"><a class="viewcode-back" href="../../api/py_dbutils.html#py_dbutils.dbconn.Connection.has_record">[docs]</a>    <span class="k">def</span> <span class="nf">has_record</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sqlstring</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Takes a query string and runs it to see if it returns any rows</span>

<span class="sd">        Args:</span>
<span class="sd">          sqlstring (str): String</span>

<span class="sd">        Returns:</span>
<span class="sd">          boolean: True/False</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">create_cur</span><span class="p">()</span>
        <span class="n">rs</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">record_len</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">rs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">sqlstring</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;error in dbconn.has_record: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sqlstring</span><span class="p">))</span>
        <span class="n">record_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">rs</span><span class="p">)</span>
        <span class="c1"># we need to close this or it will lock the connection</span>

        <span class="k">if</span> <span class="n">record_len</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="kc">False</span></div>

<div class="viewcode-block" id="Connection.query"><a class="viewcode-back" href="../../api/py_dbutils.html#py_dbutils.dbconn.Connection.query">[docs]</a>    <span class="k">def</span> <span class="nf">query</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sqlstring</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Describe Method:</span>

<span class="sd">        Args:(self, sqlstring):</span>
<span class="sd">          table_name (str): String</span>

<span class="sd">        Returns:</span>
<span class="sd">          None: None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">create_cur</span><span class="p">()</span>
        <span class="sd">&quot;&quot;&quot; runs query or procedure that returns record set</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Running Query: </span><span class="si">{}</span><span class="se">\n\t</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">time</span><span class="p">(),</span> <span class="n">sqlstring</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">sqlstring</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;select&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">sqlstring</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;call&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">sqlstring</span><span class="p">)</span>
            <span class="n">rows</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Only Selects allowed&#39;</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Query Completed: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">time</span><span class="p">()))</span>
        <span class="k">return</span> <span class="n">rows</span></div>

<div class="viewcode-block" id="Connection.insert_table"><a class="viewcode-back" href="../../api/py_dbutils.html#py_dbutils.dbconn.Connection.insert_table">[docs]</a>    <span class="k">def</span> <span class="nf">insert_table</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table_name</span><span class="p">,</span> <span class="n">column_list</span><span class="p">,</span> <span class="n">values</span><span class="p">,</span> <span class="n">onconflict</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Describe Method:</span>

<span class="sd">        Args:(self, table_name, column_list, values, onconflict=&#39;&#39;):</span>
<span class="sd">          table_name (str): String</span>

<span class="sd">        Returns:</span>
<span class="sd">          None: None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">create_cur</span><span class="p">()</span>
        <span class="n">sqlstring</span> <span class="o">=</span> <span class="s2">&quot;Insert into &quot;</span> <span class="o">+</span> <span class="n">table_name</span> <span class="o">+</span> <span class="s2">&quot; (&quot;</span> <span class="o">+</span> <span class="n">column_list</span> <span class="o">+</span> <span class="s2">&quot;) values &quot;</span> <span class="o">+</span> <span class="n">values</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="n">onconflict</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">sqlstring</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">last_row_count</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">rowcount</span></div>

<div class="viewcode-block" id="Connection.commit"><a class="viewcode-back" href="../../api/py_dbutils.html#py_dbutils.dbconn.Connection.commit">[docs]</a>    <span class="k">def</span> <span class="nf">commit</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Describe Method:</span>

<span class="sd">        Args:(self):</span>
<span class="sd">          table_name (str): String</span>

<span class="sd">        Returns:</span>
<span class="sd">          None: None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="sd">&quot;&quot;&quot; Default to commit after every transaction</span>
<span class="sd">                Will check instance variable to decide if a commit is needed</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;COMMIT&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;No Open Cursor to do Commit&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">e</span><span class="p">)</span></div>

<div class="viewcode-block" id="Connection.rollback"><a class="viewcode-back" href="../../api/py_dbutils.html#py_dbutils.dbconn.Connection.rollback">[docs]</a>    <span class="k">def</span> <span class="nf">rollback</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Describe Method:</span>

<span class="sd">        Args:(self):</span>
<span class="sd">          table_name (str): String</span>

<span class="sd">        Returns:</span>
<span class="sd">          None: None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;ROLLBACK&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span> <span class="o">=</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="Connection.execute"><a class="viewcode-back" href="../../api/py_dbutils.html#py_dbutils.dbconn.Connection.execute">[docs]</a>    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sqlstring</span><span class="p">,</span> <span class="n">commit</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">catch_exception</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Describe Method:</span>

<span class="sd">        Args:(self, sqlstring, commit=False, catch_exception=True):</span>
<span class="sd">          table_name (str): String</span>

<span class="sd">        Returns:</span>
<span class="sd">          None: None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">create_cur</span><span class="p">()</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="s2">&quot;Debug DB Execute: </span><span class="si">{}</span><span class="s2">:</span><span class="si">{}</span><span class="s2">:</span><span class="si">{}</span><span class="s2"> </span><span class="se">\n\t</span><span class="si">{}</span><span class="s2"> &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_userid</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_host</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_database_name</span><span class="p">,</span> <span class="n">sqlstring</span><span class="p">))</span>
        <span class="n">rowcount</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">sql</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">sqlstring</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">catch_exception</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="c1"># print(&quot;Error Execute SQL:{}&quot;.format(e))</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;SQL error Occurred But Continuing:</span><span class="se">\n</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span>
        <span class="n">rowcount</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">rowcount</span>
        <span class="k">if</span> <span class="n">commit</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;DB Execute Completed: </span><span class="si">{}</span><span class="s2">:</span><span class="si">{}</span><span class="s2">:</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_userid</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_host</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_database_name</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">rowcount</span></div>

<div class="viewcode-block" id="Connection.drop_schema"><a class="viewcode-back" href="../../api/py_dbutils.html#py_dbutils.dbconn.Connection.drop_schema">[docs]</a>    <span class="k">def</span> <span class="nf">drop_schema</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">schema</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Describe Method:</span>

<span class="sd">        Args:(self, schema):</span>
<span class="sd">          table_name (str): String</span>

<span class="sd">        Returns:</span>
<span class="sd">          None: None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">create_cur</span><span class="p">()</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="s2">&quot;Drop Database Schema: </span><span class="se">\n\t</span><span class="s2">Host:</span><span class="si">{0}</span><span class="se">\n\t</span><span class="s2">Database:</span><span class="si">{1}</span><span class="se">\n</span><span class="s2">Schema:</span><span class="si">{2}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_host</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_database_name</span><span class="p">,</span>
                                                                                    <span class="n">schema</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;drop schema </span><span class="si">{0}</span><span class="s1"> cascade&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">schema</span><span class="p">)))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span></div>

<div class="viewcode-block" id="Connection.truncate_table"><a class="viewcode-back" href="../../api/py_dbutils.html#py_dbutils.dbconn.Connection.truncate_table">[docs]</a>    <span class="k">def</span> <span class="nf">truncate_table</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">commit</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Describe Method:</span>

<span class="sd">        Args:(self, table_name=None, commit=True):</span>
<span class="sd">          table_name (str): String</span>

<span class="sd">        Returns:</span>
<span class="sd">          None: None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">create_cur</span><span class="p">()</span>
        <span class="n">dbschema</span> <span class="o">=</span> <span class="n">table_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">str_string</span> <span class="o">=</span> <span class="s2">&quot;Truncating Table: </span><span class="se">\n\t</span><span class="s2">Host:</span><span class="si">{0}</span><span class="se">\n\t</span><span class="s2">Database:</span><span class="si">{1}</span><span class="se">\n\t</span><span class="s2">Tablename:</span><span class="si">{2}</span><span class="se">\n\t</span><span class="s2">Schema:</span><span class="si">{3}</span><span class="s2">&quot;</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">str_string</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_host</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_database_name</span><span class="p">,</span> <span class="n">table_name</span><span class="p">,</span> <span class="n">dbschema</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;TRUNCATE table </span><span class="si">{0}</span><span class="s1"> cascade&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">table_name</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">commit</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span></div>

<div class="viewcode-block" id="Connection.update"><a class="viewcode-back" href="../../api/py_dbutils.html#py_dbutils.dbconn.Connection.update">[docs]</a>    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sqlstring</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Describe Method:</span>

<span class="sd">        Args:(self, sqlstring):</span>
<span class="sd">          table_name (str): String</span>

<span class="sd">        Returns:</span>
<span class="sd">          None: None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">create_cur</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">sqlstring</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span></div>

<div class="viewcode-block" id="Connection.create_cur"><a class="viewcode-back" href="../../api/py_dbutils.html#py_dbutils.dbconn.Connection.create_cur">[docs]</a>    <span class="k">def</span> <span class="nf">create_cur</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Describe Method:</span>

<span class="sd">        Args:(self):</span>
<span class="sd">          table_name (str): String</span>

<span class="sd">        Returns:</span>
<span class="sd">          None: None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span></div>

<div class="viewcode-block" id="Connection.drop_table"><a class="viewcode-back" href="../../api/py_dbutils.html#py_dbutils.dbconn.Connection.drop_table">[docs]</a>    <span class="k">def</span> <span class="nf">drop_table</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table_name</span><span class="p">,</span> <span class="n">cascade</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">commit</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Describe Method:</span>

<span class="sd">        Args:(self, table_name,cascade=False,commit=True):</span>
<span class="sd">          table_name (str): String</span>

<span class="sd">        Returns:</span>
<span class="sd">          None: None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">create_cur</span><span class="p">()</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Dropping Table(if Exists): </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">table_name</span><span class="p">))</span>
        <span class="n">opt</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">cascade</span> <span class="k">else</span> <span class="s1">&#39;CASCADE&#39;</span>
        <span class="n">sql</span> <span class="o">=</span> <span class="s1">&#39;Drop table if exists </span><span class="si">{0}</span><span class="s1"> </span><span class="si">{1}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">table_name</span><span class="p">,</span> <span class="n">opt</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">commit</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>  <span class="c1"># if we don&#39;t commit that table will be locked</span></div>

<div class="viewcode-block" id="Connection.create_table"><a class="viewcode-back" href="../../api/py_dbutils.html#py_dbutils.dbconn.Connection.create_table">[docs]</a>    <span class="k">def</span> <span class="nf">create_table</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sqlstring</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Describe Method:</span>

<span class="sd">        Args:(self, sqlstring):</span>
<span class="sd">          table_name (str): String</span>

<span class="sd">        Returns:</span>
<span class="sd">          None: None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">create_cur</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">sqlstring</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;create table &#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">sqlstring</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;create tables functions allowed&#39;</span><span class="p">)</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_connect_postgres</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Describe Method:</span>

<span class="sd">        Args:(self):</span>
<span class="sd">          table_name (str): String</span>

<span class="sd">        Returns:</span>
<span class="sd">          None: None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">psycopg2</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_password</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_password</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;PGPASSWORD&#39;</span><span class="p">,</span> <span class="s1">&#39;tester&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_userid</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_userid</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;PGUSER&#39;</span><span class="p">,</span> <span class="s1">&#39;postgres&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sslmode</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_sslmode</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;PGSSLMODE&#39;</span><span class="p">,</span> <span class="s1">&#39;prefer&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_host</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_host</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;PGHOST&#39;</span><span class="p">,</span> <span class="s1">&#39;192.168.99.100&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_port</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_port</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;PGPORT&#39;</span><span class="p">,</span> <span class="mi">5432</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_database_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_database_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;PGDATABASE&#39;</span><span class="p">,</span> <span class="s1">&#39;postgres&#39;</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_port</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_port</span> <span class="o">=</span> <span class="mi">5432</span>
        <span class="n">conn</span> <span class="o">=</span> <span class="n">psycopg2</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">dbname</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_database_name</span><span class="p">,</span> <span class="n">user</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_userid</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_password</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_port</span><span class="p">,</span>
                                <span class="n">host</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_host</span><span class="p">,</span> <span class="n">application_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">appname</span><span class="p">,</span> <span class="n">sslmode</span><span class="o">=</span><span class="s1">&#39;prefer&#39;</span><span class="p">)</span>
        <span class="n">conn</span><span class="o">.</span><span class="n">set_client_encoding</span><span class="p">(</span><span class="s1">&#39;UNICODE&#39;</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Connected to POSTGRES: </span><span class="si">{}</span><span class="s1">:</span><span class="si">{}</span><span class="s1">:</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_host</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_database_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_userid</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">conn</span>

    <span class="k">def</span> <span class="nf">_connect_mssql</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">appname</span><span class="o">=</span><span class="s1">&#39;py_dbutils&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Describe Method:</span>

<span class="sd">        Args:(self, appname=&#39;py_dbutils&#39;):</span>
<span class="sd">          table_name (str): String</span>

<span class="sd">        Returns:</span>
<span class="sd">          None: None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">pymssql</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_password</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;MSPASSWORD&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="c1"># conn = pymssql.connect(server=self._host, user=self._userid, password=self._password,</span>
        <span class="c1">#                       database=self._database_name, host=self._host, port=self._port, conn_properties=None,</span>
        <span class="c1">#                       timeout=0, login_timeout=60, charset=&#39;UTF-8&#39;, as_dict=False, appname=appname,</span>
        <span class="c1">#                       autocommit=self._commit, tds_version=&#39;7.1&#39;)</span>
        <span class="nb">print</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_host</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_port</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_userid</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_password</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_database_name</span><span class="p">)</span>

        <span class="n">conn</span> <span class="o">=</span> <span class="n">pymssql</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span>
            <span class="n">server</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_host</span><span class="p">,</span>
            <span class="n">port</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_port</span><span class="p">,</span>
            <span class="n">user</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_userid</span><span class="p">,</span>
            <span class="n">password</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_password</span><span class="p">,</span>
            <span class="n">database</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_database_name</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">conn</span>

    <span class="k">def</span> <span class="nf">_connect_mysql</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Describe Method:</span>

<span class="sd">        Args:(self):</span>
<span class="sd">          table_name (str): String</span>

<span class="sd">        Returns:</span>
<span class="sd">          None: None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Connecting to mysql:&quot;</span><span class="p">)</span>
        <span class="c1"># import mysql.connector</span>
        <span class="kn">import</span> <span class="nn">pymysql</span>

        <span class="n">conn</span> <span class="o">=</span> <span class="n">pymysql</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">user</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_userid</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_password</span><span class="p">,</span>
                               <span class="n">host</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_host</span><span class="p">,</span>
                               <span class="n">database</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_database_name</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;coneected&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">conn</span>

    <span class="k">def</span> <span class="nf">_connect_oracle</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Describe Method:</span>

<span class="sd">        Args:(self):</span>
<span class="sd">          table_name (str): String</span>

<span class="sd">        Returns:</span>
<span class="sd">          None: None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">_connect_ldap</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Describe Method:</span>

<span class="sd">        Args:(self):</span>
<span class="sd">          table_name (str): String</span>

<span class="sd">        Returns:</span>
<span class="sd">          None: None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">__del__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Describe Method:</span>

<span class="sd">        Args:(self):</span>
<span class="sd">          table_name (str): String</span>

<span class="sd">        Returns:</span>
<span class="sd">          None: None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">commit</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Auto Commit ON: Commiting&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Auto Commit OFF: Rolling Back:&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Closed DB Connection: </span><span class="si">{0}</span><span class="s2">:</span><span class="si">{1}</span><span class="s2">:</span><span class="si">{2}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_host</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_database_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dbtype</span><span class="p">))</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">pass</span>

<div class="viewcode-block" id="Connection.copy_to_csv"><a class="viewcode-back" href="../../api/py_dbutils.html#py_dbutils.dbconn.Connection.copy_to_csv">[docs]</a>    <span class="k">def</span> <span class="nf">copy_to_csv</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sqlstring</span><span class="p">,</span> <span class="n">full_file_path</span><span class="p">,</span> <span class="n">delimiter</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Describe Method:</span>

<span class="sd">        Args:(self, sqlstring, full_file_path, delimiter):</span>
<span class="sd">          table_name (str): String</span>

<span class="sd">        Returns:</span>
<span class="sd">          None: None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">total_rows</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dbtype</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;POSTGRES&#39;</span><span class="p">,</span> <span class="s1">&#39;CITUS&#39;</span><span class="p">]:</span>
            <span class="n">outputquery</span> <span class="o">=</span> <span class="s2">&quot;COPY (</span><span class="si">{0}</span><span class="s2">) TO STDOUT WITH CSV HEADER&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sqlstring</span><span class="p">)</span>

            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">full_file_path</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">copy_expert</span><span class="p">(</span><span class="n">outputquery</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dbtype</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;MSSQL&#39;</span><span class="p">]:</span>
            <span class="kn">import</span> <span class="nn">pandas</span>

            <span class="n">df</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">read_sql_query</span><span class="p">(</span><span class="n">sqlstring</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_conn</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">coerce_float</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                       <span class="n">parse_dates</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">chunksize</span><span class="o">=</span><span class="mi">100000</span><span class="p">)</span>
            <span class="c1"># df.to_csv(full_file_path,header=false,sep=delimiter)</span>

            <span class="k">for</span> <span class="n">chunk</span> <span class="ow">in</span> <span class="n">df</span><span class="p">:</span>
                <span class="n">total_rows</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span>
                <span class="n">chunk</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">full_file_path</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="n">delimiter</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;a&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">total_rows</span></div>

<div class="viewcode-block" id="Connection.get_conn_url"><a class="viewcode-back" href="../../api/py_dbutils.html#py_dbutils.dbconn.Connection.get_conn_url">[docs]</a>    <span class="k">def</span> <span class="nf">get_conn_url</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Describe Method:</span>

<span class="sd">        Args:(self):</span>
<span class="sd">          table_name (str): String</span>

<span class="sd">        Returns:</span>
<span class="sd">          None: None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dbtype</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;POSTGRES&quot;</span><span class="p">,</span> <span class="s2">&quot;CITUS&quot;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">url</span> <span class="o">=</span> <span class="s1">&#39;postgresql://</span><span class="si">{}</span><span class="s1">:</span><span class="si">{}</span><span class="s1">@</span><span class="si">{}</span><span class="s1">:</span><span class="si">{}</span><span class="s1">/</span><span class="si">{}</span><span class="s1">&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">url</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_userid</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_password</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_host</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_port</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_database_name</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">url</span></div>

    <span class="c1"># @migrate_utils.static_func.timer</span>
<div class="viewcode-block" id="Connection.get_table_list_via_query"><a class="viewcode-back" href="../../api/py_dbutils.html#py_dbutils.dbconn.Connection.get_table_list_via_query">[docs]</a>    <span class="k">def</span> <span class="nf">get_table_list_via_query</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dbschema</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Describe Method:</span>

<span class="sd">        Args:(self, dbschema):</span>
<span class="sd">          table_name (str): String</span>

<span class="sd">        Returns:</span>
<span class="sd">          None: None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">sql</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;SELECT table_name FROM information_schema.tables a</span>
<span class="s2">            WHERE table_schema=&#39;</span><span class="si">{}</span><span class="s2">&#39; and table_type=&#39;BASE TABLE&#39;&quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dbschema</span><span class="p">)</span>
        <span class="n">result_set</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">result_set</span><span class="p">]</span></div>

<div class="viewcode-block" id="Connection.get_view_list_via_query"><a class="viewcode-back" href="../../api/py_dbutils.html#py_dbutils.dbconn.Connection.get_view_list_via_query">[docs]</a>    <span class="k">def</span> <span class="nf">get_view_list_via_query</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dbschema</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Describe Method:</span>

<span class="sd">        Args:(self, dbschema):</span>
<span class="sd">          table_name (str): String</span>

<span class="sd">        Returns:</span>
<span class="sd">          None: None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">sql</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;SELECT table_name FROM information_schema.tables a</span>
<span class="s2">            WHERE table_schema=&#39;</span><span class="si">{}</span><span class="s2">&#39; and table_type=&#39;VIEW&#39;&quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dbschema</span><span class="p">)</span>
        <span class="n">result_set</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">result_set</span><span class="p">]</span></div>

    <span class="c1"># @migrate_utils.static_func.timer</span>
<div class="viewcode-block" id="Connection.get_all_columns_schema"><a class="viewcode-back" href="../../api/py_dbutils.html#py_dbutils.dbconn.Connection.get_all_columns_schema">[docs]</a>    <span class="k">def</span> <span class="nf">get_all_columns_schema</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dbschema</span><span class="p">,</span> <span class="n">table_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Describe Method:</span>

<span class="sd">        Args:(self, dbschema, table_name):</span>
<span class="sd">          table_name (str): String</span>

<span class="sd">        Returns:</span>
<span class="sd">          None: None</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">sql</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;SELECT table_name,column_name,upper(data_type) as type,</span>
<span class="s2">        is_identity,</span>
<span class="s2">        character_maximum_length</span>
<span class="s2">        FROM information_schema.columns</span>
<span class="s2">        WHERE table_schema = &#39;</span><span class="si">{}</span><span class="s2">&#39;</span>
<span class="s2">        AND table_name   = &#39;</span><span class="si">{}</span><span class="s2">&#39;</span>
<span class="s2">        order by table_name,ordinal_position&quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dbschema</span><span class="p">,</span> <span class="n">table_name</span><span class="p">)</span>
        <span class="n">result_set</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span>
        <span class="n">table</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">table_name</span><span class="p">,</span> <span class="n">column</span><span class="p">,</span> <span class="nb">type</span><span class="p">,</span> <span class="n">autoincrement</span><span class="p">,</span> <span class="n">length</span> <span class="ow">in</span> <span class="n">result_set</span><span class="p">:</span>
            <span class="k">class</span> <span class="nc">data</span><span class="p">:</span>
                <span class="k">pass</span>

            <span class="n">data</span><span class="o">.</span><span class="n">table_name</span> <span class="o">=</span> <span class="n">table_name</span>
            <span class="n">data</span><span class="o">.</span><span class="n">column_name</span> <span class="o">=</span> <span class="n">column</span>
            <span class="n">data</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="nb">type</span>
            <span class="n">data</span><span class="o">.</span><span class="n">autoincrement</span> <span class="o">=</span> <span class="n">autoincrement</span>
            <span class="n">data</span><span class="o">.</span><span class="n">length</span> <span class="o">=</span> <span class="n">length</span>

            <span class="n">table</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">table</span></div>

    <span class="c1"># this one breaks w/ sqlserver</span>
    <span class="c1"># @migrate_utils.static_func.timer</span>
<div class="viewcode-block" id="Connection.get_table_list"><a class="viewcode-back" href="../../api/py_dbutils.html#py_dbutils.dbconn.Connection.get_table_list">[docs]</a>    <span class="k">def</span> <span class="nf">get_table_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dbschema</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Describe Method:</span>

<span class="sd">        Args:(self, dbschema=None):</span>
<span class="sd">          table_name (str): String</span>

<span class="sd">        Returns:</span>
<span class="sd">          None: None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">sqlalchemy.ext.automap</span> <span class="k">import</span> <span class="n">automap_base</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;getting schema: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dbschema</span><span class="p">))</span>
        <span class="n">Base</span> <span class="o">=</span> <span class="n">automap_base</span><span class="p">()</span>

        <span class="c1"># from sqlalchemy.orm import Session</span>
        <span class="n">schema</span> <span class="o">=</span> <span class="n">dbschema</span>
        <span class="k">if</span> <span class="n">dbschema</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">schema</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbschema</span>

        <span class="n">con</span><span class="p">,</span> <span class="n">meta</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">connect_sqlalchemy</span><span class="p">(</span><span class="n">schema</span><span class="o">=</span><span class="n">schema</span><span class="p">)</span>
        <span class="n">Base</span><span class="o">.</span><span class="n">prepare</span><span class="p">(</span><span class="n">con</span><span class="p">,</span> <span class="n">reflect</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">schema</span><span class="o">=</span><span class="n">schema</span><span class="p">)</span>
        <span class="n">l</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">t</span><span class="p">,</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">Base</span><span class="o">.</span><span class="n">classes</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="c1"># print(t,(k.__dict__))</span>
            <span class="c1"># for m in k:</span>
            <span class="n">l</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">l</span></div>

    <span class="c1"># returns list of tables that are not assigned to common roles</span>

<div class="viewcode-block" id="Connection.get_uncommon_tables"><a class="viewcode-back" href="../../api/py_dbutils.html#py_dbutils.dbconn.Connection.get_uncommon_tables">[docs]</a>    <span class="k">def</span> <span class="nf">get_uncommon_tables</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">common_roles</span><span class="o">=</span><span class="s1">&#39;operational_dba&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Describe Method:</span>

<span class="sd">        Args:(self, common_roles=&#39;operational_dba&#39;):</span>
<span class="sd">          table_name (str): String</span>

<span class="sd">        Returns:</span>
<span class="sd">          None: None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">sql</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;SELECT t.table_schema,t.table_name ,u.usename as ownername,p.grantor,p.grantee</span>
<span class="s2">            ,c.relname , c.relowner ,p.*</span>
<span class="s2">            from information_schema.tables t</span>
<span class="s2">            left outer join information_schema.table_privileges p on p.table_schema=t.table_schema and p.table_name=t.table_name</span>
<span class="s2">            and (grantor  in (&#39;operational_dba&#39;) and grantee  in (&#39;operational_dba&#39;) )</span>
<span class="s2">            , pg_catalog.pg_user u,</span>
<span class="s2">            pg_catalog.pg_class c</span>
<span class="s2">            where t.table_name=c.relname</span>
<span class="s2">            and c.relowner=u.usesysid</span>
<span class="s2">            and u.usename not in (&#39;svc_opdba&#39;,&#39;operational_dba&#39;)</span>
<span class="s2">            and p.grantee is null</span>
<span class="s2">            and t.table_schema not in (&#39;pg_catalog&#39;,&#39;sys&#39;,&#39;information_schema&#39;,&#39;cfpb_admin&#39;);</span>
<span class="s2">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span></div>

    <span class="c1"># #@migrate_utils.static_func.timer</span>
<div class="viewcode-block" id="Connection.get_columns"><a class="viewcode-back" href="../../api/py_dbutils.html#py_dbutils.dbconn.Connection.get_columns">[docs]</a>    <span class="k">def</span> <span class="nf">get_columns</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table_name</span><span class="p">,</span> <span class="n">table_schema</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Describe Method:</span>

<span class="sd">        Args:(self, table_name, table_schema):</span>
<span class="sd">          table_name (str): String</span>

<span class="sd">        Returns:</span>
<span class="sd">          None: None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        :rtype: object</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># type: (str, str) -&gt; list</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Getting Column List from DB: </span><span class="si">{}</span><span class="s2">.</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">table_schema</span><span class="p">,</span> <span class="n">table_name</span><span class="p">))</span>
            <span class="n">con</span><span class="p">,</span> <span class="n">meta</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">connect_sqlalchemy</span><span class="p">(</span><span class="n">table_schema</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dbtype</span><span class="p">)</span>
            <span class="n">table</span> <span class="o">=</span> <span class="n">sqlalchemy</span><span class="o">.</span><span class="n">Table</span><span class="p">(</span><span class="n">table_name</span><span class="p">,</span> <span class="n">meta</span><span class="p">,</span> <span class="n">autoload</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">autoload_with</span><span class="o">=</span><span class="n">con</span><span class="p">)</span>
            <span class="n">column_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">table</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
            <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">column_list</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;No Columns found when trying to get Column List: Returning None&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">[]</span></div>

    <span class="c1"># returns a list of table dict</span>
    <span class="c1"># @migrate_utils.static_func.timer</span>
<div class="viewcode-block" id="Connection.get_tables"><a class="viewcode-back" href="../../api/py_dbutils.html#py_dbutils.dbconn.Connection.get_tables">[docs]</a>    <span class="k">def</span> <span class="nf">get_tables</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">schema</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Describe Method:</span>

<span class="sd">        Args:(self, schema=None):</span>
<span class="sd">          table_name (str): String</span>

<span class="sd">        Returns:</span>
<span class="sd">          None: None</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">dbschema</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbschema</span>
        <span class="k">if</span> <span class="n">schema</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">dbschema</span> <span class="o">=</span> <span class="n">schema</span>

        <span class="n">con</span><span class="p">,</span> <span class="n">meta</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">connect_sqlalchemy</span><span class="p">(</span><span class="n">dbschema</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dbtype</span><span class="p">)</span>

        <span class="n">table_obj</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">meta</span><span class="o">.</span><span class="n">tables</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">table</span> <span class="o">=</span> <span class="n">sqlalchemy</span><span class="o">.</span><span class="n">Table</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">meta</span><span class="p">,</span> <span class="n">autoload</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">autoload_with</span><span class="o">=</span><span class="n">con</span><span class="p">)</span>
            <span class="n">column_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">table</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
            <span class="n">d</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">({</span><span class="s2">&quot;db&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_database_name</span><span class="p">,</span> <span class="s2">&quot;schema&quot;</span><span class="p">:</span> <span class="n">dbschema</span><span class="p">,</span> <span class="s2">&quot;table_name&quot;</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s2">&quot;columns&quot;</span><span class="p">:</span> <span class="n">column_list</span><span class="p">})</span>
            <span class="n">table_obj</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">table_obj</span></div>

    <span class="c1"># @migrate_utils.static_func.timer</span>
<div class="viewcode-block" id="Connection.get_table_row_count_fast"><a class="viewcode-back" href="../../api/py_dbutils.html#py_dbutils.dbconn.Connection.get_table_row_count_fast">[docs]</a>    <span class="k">def</span> <span class="nf">get_table_row_count_fast</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table_name</span><span class="p">,</span> <span class="n">schema</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Describe Method:</span>

<span class="sd">        Args:(self, table_name, schema=None):</span>
<span class="sd">          table_name (str): String</span>

<span class="sd">        Returns:</span>
<span class="sd">          None: None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">x</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dbtype</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;POSTGRES&#39;</span><span class="p">,</span> <span class="s1">&#39;CITUS&#39;</span><span class="p">]:</span>
            <span class="n">row</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;select n_live_tup</span>
<span class="s2">                    from pg_stat_user_tables</span>
<span class="s2">                    where schemaname=&#39;</span><span class="si">{}</span><span class="s2">&#39; and relname=&#39;</span><span class="si">{}</span><span class="s2">&#39;&quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">schema</span><span class="p">,</span> <span class="n">table_name</span><span class="p">))</span>

            <span class="n">x</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">x</span></div>

<div class="viewcode-block" id="Connection.get_a_value"><a class="viewcode-back" href="../../api/py_dbutils.html#py_dbutils.dbconn.Connection.get_a_value">[docs]</a>    <span class="k">def</span> <span class="nf">get_a_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sql</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Describe Method:</span>

<span class="sd">        Args:(self, sql):</span>
<span class="sd">          table_name (str): String</span>

<span class="sd">        Returns:</span>
<span class="sd">          None: None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">value</span></div>

<div class="viewcode-block" id="Connection.get_tables_row_count"><a class="viewcode-back" href="../../api/py_dbutils.html#py_dbutils.dbconn.Connection.get_tables_row_count">[docs]</a>    <span class="k">def</span> <span class="nf">get_tables_row_count</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">schema</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Describe Method:</span>

<span class="sd">        Args:(self, schema=None):</span>
<span class="sd">          table_name (str): String</span>

<span class="sd">        Returns:</span>
<span class="sd">          None: None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">schema</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">schema</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbschema</span>
        <span class="n">con</span><span class="p">,</span> <span class="n">meta</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">connect_sqlalchemy</span><span class="p">(</span><span class="n">schema</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dbtype</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="nb">dir</span><span class="p">(</span><span class="n">meta</span><span class="o">.</span><span class="n">tables</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">schema</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dbtype</span><span class="p">)</span>
        <span class="n">tables</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_table_list_via_query</span><span class="p">(</span><span class="n">schema</span><span class="p">)</span>
        <span class="n">table_obj</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tables</span><span class="p">:</span>
            <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;select count(1) from </span><span class="si">{}</span><span class="s2">.</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">schema</span><span class="p">,</span> <span class="n">t</span><span class="p">))</span>
            <span class="n">rowcount</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="c1"># print(type(rowcount),dir(rowcount))</span>
            <span class="n">d</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">({</span><span class="s2">&quot;db&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_database_name</span><span class="p">,</span> <span class="s2">&quot;schema&quot;</span><span class="p">:</span> <span class="n">schema</span><span class="p">,</span> <span class="s2">&quot;table_name&quot;</span><span class="p">:</span> <span class="n">t</span><span class="p">,</span> <span class="s2">&quot;row_counts&quot;</span><span class="p">:</span> <span class="n">rowcount</span><span class="p">})</span>
            <span class="n">table_obj</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">table_obj</span></div>

    <span class="c1"># given a table name we return the a list of columns that are part of the primary key</span>
<div class="viewcode-block" id="Connection.get_primary_keys"><a class="viewcode-back" href="../../api/py_dbutils.html#py_dbutils.dbconn.Connection.get_primary_keys">[docs]</a>    <span class="k">def</span> <span class="nf">get_primary_keys</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Describe Method:</span>

<span class="sd">        Args:(self, table_name):</span>
<span class="sd">          table_name (str): String</span>

<span class="sd">        Returns:</span>
<span class="sd">          None: None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">sql</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;SELECT a.attname, format_type(a.atttypid, a.atttypmod) AS data_type</span>
<span class="s2">            FROM   pg_index i</span>
<span class="s2">            JOIN   pg_attribute a ON a.attrelid = i.indrelid</span>
<span class="s2">                     AND a.attnum = ANY(i.indkey)</span>
<span class="s2">            WHERE  i.indrelid = &#39;</span><span class="si">{}</span><span class="s2">&#39;::regclass</span>
<span class="s2">            AND    i.indisprimary;&quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">table_name</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span>
        <span class="n">field_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
            <span class="c1"># convert tuple to variable when having atleast 2 columns</span>
            <span class="n">field_name</span><span class="p">,</span> <span class="n">data_type</span> <span class="o">=</span> <span class="n">row</span>
            <span class="n">field_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">field_name</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">field_list</span></div>

<div class="viewcode-block" id="Connection.print_table_info"><a class="viewcode-back" href="../../api/py_dbutils.html#py_dbutils.dbconn.Connection.print_table_info">[docs]</a>    <span class="k">def</span> <span class="nf">print_table_info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table_name</span><span class="p">,</span> <span class="n">schema</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Describe Method:</span>

<span class="sd">        Args:(self, table_name, schema):</span>
<span class="sd">          table_name (str): String</span>

<span class="sd">        Returns:</span>
<span class="sd">          None: None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">sqlalchemy.ext.automap</span> <span class="k">import</span> <span class="n">automap_base</span>
        <span class="n">Base</span> <span class="o">=</span> <span class="n">automap_base</span><span class="p">()</span>
        <span class="c1"># from sqlalchemy.orm import Session</span>
        <span class="n">engine</span><span class="p">,</span> <span class="n">meta</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">connect_sqlalchemy</span><span class="p">()</span>
        <span class="n">Base</span><span class="o">.</span><span class="n">prepare</span><span class="p">(</span><span class="n">engine</span><span class="p">,</span> <span class="n">reflect</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">schema</span><span class="o">=</span><span class="n">schema</span><span class="p">)</span>
        <span class="n">l</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="s1">&#39;Base.classes.</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">table_name</span><span class="p">)))</span>

        <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">l</span><span class="o">.</span><span class="n">__table__</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">m</span><span class="o">.</span><span class="n">type</span><span class="p">)</span></div>

<div class="viewcode-block" id="Connection.get_db_size"><a class="viewcode-back" href="../../api/py_dbutils.html#py_dbutils.dbconn.Connection.get_db_size">[docs]</a>    <span class="k">def</span> <span class="nf">get_db_size</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Describe Method:</span>

<span class="sd">        Args:(self):</span>
<span class="sd">          table_name (str): String</span>

<span class="sd">        Returns:</span>
<span class="sd">          None: None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">sql</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;SELECT  table_schema,table_name, pg_size_pretty(total_bytes) AS total</span>
<span class="s2">    , pg_size_pretty(index_bytes) AS INDEX</span>
<span class="s2">    , pg_size_pretty(toast_bytes) AS toast</span>
<span class="s2">    , pg_size_pretty(table_bytes) AS TABLE</span>
<span class="s2">    ,total_bytes-index_bytes as data_bytes</span>
<span class="s2">    ,(total_bytes-index_bytes)/pow(1024,3) as data_gb</span>
<span class="s2">  FROM (</span>
<span class="s2">  SELECT *, total_bytes-index_bytes-COALESCE(toast_bytes,0) AS table_bytes FROM (</span>
<span class="s2">      SELECT c.oid,nspname AS table_schema, relname AS TABLE_NAME</span>
<span class="s2">              , c.reltuples AS row_estimate</span>
<span class="s2">              , pg_total_relation_size(c.oid) AS total_bytes</span>
<span class="s2">              , pg_indexes_size(c.oid) AS index_bytes</span>
<span class="s2">              , pg_total_relation_size(reltoastrelid) AS toast_bytes</span>
<span class="s2">          FROM pg_class c</span>
<span class="s2">          LEFT JOIN pg_namespace n ON n.oid = c.relnamespace</span>
<span class="s2">          WHERE relkind = &#39;r&#39;</span>
<span class="s2">  ) a</span>
<span class="s2">) a;&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span></div>

    <span class="c1"># this is only in this class for convience atm, should be moved out eventually</span>

<div class="viewcode-block" id="Connection.get_pandas_frame"><a class="viewcode-back" href="../../api/py_dbutils.html#py_dbutils.dbconn.Connection.get_pandas_frame">[docs]</a>    <span class="k">def</span> <span class="nf">get_pandas_frame</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table_name_fqn</span><span class="p">,</span> <span class="n">rows</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Describe Method:</span>

<span class="sd">        Args:(self, table_name_fqn, rows=None):</span>
<span class="sd">          table_name (str): String</span>

<span class="sd">        Returns:</span>
<span class="sd">          None: None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
        <span class="n">conn</span><span class="p">,</span> <span class="n">meta</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">connect_sqlalchemy</span><span class="p">()</span>

        <span class="n">schema</span> <span class="o">=</span> <span class="n">table_name_fqn</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">table_name</span> <span class="o">=</span> <span class="n">table_name_fqn</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>

        <span class="n">z</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_sql_table</span><span class="p">(</span><span class="n">table_name</span><span class="p">,</span> <span class="n">conn</span><span class="p">,</span> <span class="n">schema</span><span class="o">=</span><span class="n">schema</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">coerce_float</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                              <span class="n">parse_dates</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">chunksize</span><span class="o">=</span><span class="n">rows</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">z</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">z</span></div>

<div class="viewcode-block" id="Connection.put_pandas_frame"><a class="viewcode-back" href="../../api/py_dbutils.html#py_dbutils.dbconn.Connection.put_pandas_frame">[docs]</a>    <span class="k">def</span> <span class="nf">put_pandas_frame</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table_name</span><span class="p">,</span> <span class="n">df</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Describe Method:</span>

<span class="sd">        Args:(self, table_name, df):</span>
<span class="sd">          table_name (str): String</span>

<span class="sd">        Returns:</span>
<span class="sd">          None: None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">conn</span><span class="p">,</span> <span class="n">meta</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">connect_sqlalchemy</span><span class="p">()</span>
        <span class="n">z</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">to_sql</span><span class="p">(</span><span class="n">table_name</span><span class="p">,</span> <span class="n">conn</span><span class="p">,</span> <span class="n">schema</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dbschema</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">if_exists</span><span class="o">=</span><span class="s1">&#39;append&#39;</span><span class="p">,</span> <span class="n">chunksize</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                      <span class="n">dtype</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">z</span></div>

    <span class="c1"># certain commans requires the environment variables for the session</span>
    <span class="c1"># we need to save that and replace with our current and put it back after we are done</span>

    <span class="k">def</span> <span class="nf">_get_environment_vars</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Describe Method:</span>

<span class="sd">        Args:(self):</span>
<span class="sd">          table_name (str): String</span>

<span class="sd">        Returns:</span>
<span class="sd">          None: None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">envar</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dbtype</span> <span class="o">==</span> <span class="s1">&#39;POSTGRES&#39;</span><span class="p">:</span>
            <span class="n">envar</span><span class="p">[</span><span class="s1">&#39;PGPASSWORD&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;PGPASSWORD&#39;</span><span class="p">]</span>
            <span class="n">envar</span><span class="p">[</span><span class="s1">&#39;PGUSER&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;PGUSER&#39;</span><span class="p">]</span>
            <span class="n">envar</span><span class="p">[</span><span class="s1">&#39;PGSSLMODE&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;PGSSLMODE&#39;</span><span class="p">]</span>
            <span class="n">envar</span><span class="p">[</span><span class="s1">&#39;PGHOST&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;PGHOST&#39;</span><span class="p">]</span>
            <span class="n">envar</span><span class="p">[</span><span class="s1">&#39;PGPORT&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;PGPORT&#39;</span><span class="p">]</span>
            <span class="n">envar</span><span class="p">[</span><span class="s1">&#39;PGDATABASE&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;PGDATABASE&#39;</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">envar</span>

    <span class="k">def</span> <span class="nf">_save_environment_vars</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Describe Method:</span>

<span class="sd">        Args:(self):</span>
<span class="sd">          table_name (str): String</span>

<span class="sd">        Returns:</span>
<span class="sd">          None: None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dbtype</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;POSTGRES&#39;</span><span class="p">,</span> <span class="s1">&#39;CITUS&#39;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_pg_password</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;PGPASSWORD&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_password</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_pg_userid</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;PGUSER&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_userid</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_pg_sslmode</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;PGSSLMODE&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sslmode</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_pg_host</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;PGHOST&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_host</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_pg_port</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;PGPORT&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_port</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_pg_database_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;PGDATABASE&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_database_name</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_restore_environment_vars</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Describe Method:</span>

<span class="sd">        Args:(self):</span>
<span class="sd">          table_name (str): String</span>

<span class="sd">        Returns:</span>
<span class="sd">          None: None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dbtype</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;POSTGRES&#39;</span><span class="p">,</span> <span class="s1">&#39;CITUS&#39;</span><span class="p">]:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;PGPASSWORD&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pg_password</span>
            <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;PGUSER&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pg_userid</span>
            <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;PGSSLMODE&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pg_sslmode</span>
            <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;PGHOST&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pg_host</span>
            <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;PGPORT&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pg_port</span>
            <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;PGDATABASE&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pg_database_name</span>

    <span class="k">def</span> <span class="nf">_replace_environment_vars</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Describe Method:</span>

<span class="sd">        Args:(self):</span>
<span class="sd">          table_name (str): String</span>

<span class="sd">        Returns:</span>
<span class="sd">          None: None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dbtype</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;POSTGRES&#39;</span><span class="p">,</span> <span class="s1">&#39;CITUS&#39;</span><span class="p">]:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;PGPASSWORD&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_password</span>
            <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;PGUSER&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_userid</span>
            <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;PGSSLMODE&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sslmode</span>
            <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;PGHOST&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_host</span>
            <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;PGPORT&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_port</span><span class="p">)</span>
            <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;PGDATABASE&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_database_name</span>

<div class="viewcode-block" id="Connection.set_table_owner"><a class="viewcode-back" href="../../api/py_dbutils.html#py_dbutils.dbconn.Connection.set_table_owner">[docs]</a>    <span class="k">def</span> <span class="nf">set_table_owner</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table_name_fqn</span><span class="p">,</span> <span class="n">role</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Describe Method:</span>

<span class="sd">        Args:(self, table_name_fqn, role):</span>
<span class="sd">          table_name (str): String</span>

<span class="sd">        Returns:</span>
<span class="sd">          None: None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dbtype</span> <span class="o">==</span> <span class="s1">&#39;POSTGRES&#39;</span><span class="p">:</span>
            <span class="n">sql</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;ALTER TABLE </span><span class="si">{table_name}</span><span class="s2"></span>
<span class="s2">                    OWNER to </span><span class="si">{role}</span><span class="s2">&quot;&quot;&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">sql</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">table_name</span><span class="o">=</span><span class="n">table_name_fqn</span><span class="p">,</span> <span class="n">role</span><span class="o">=</span><span class="n">role</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Not Supported&#39;</span><span class="p">)</span>
            <span class="k">raise</span></div>

<div class="viewcode-block" id="Connection.create_table_from_dataframe"><a class="viewcode-back" href="../../api/py_dbutils.html#py_dbutils.dbconn.Connection.create_table_from_dataframe">[docs]</a>    <span class="k">def</span> <span class="nf">create_table_from_dataframe</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dataframe</span><span class="p">,</span> <span class="n">table_name_fqn</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Describe Method:</span>

<span class="sd">        Args:(self, dataframe, table_name_fqn):</span>
<span class="sd">          table_name (str): String</span>

<span class="sd">        Returns:</span>
<span class="sd">          None: None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="s1">&#39;.&#39;</span> <span class="ow">in</span> <span class="n">table_name_fqn</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_table_exists</span><span class="p">(</span><span class="n">table_name_fqn</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">create_cur</span><span class="p">()</span>
                <span class="n">df</span> <span class="o">=</span> <span class="n">dataframe</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
                <span class="n">schema</span> <span class="o">=</span> <span class="n">table_name_fqn</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">table_name</span> <span class="o">=</span> <span class="n">table_name_fqn</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sqlalchemy_engine_close</span><span class="p">()</span>
                <span class="n">sqlalchemy_conn</span><span class="p">,</span> <span class="n">meta</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">connect_sqlalchemy</span><span class="p">()</span>

                <span class="nb">print</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">sqlalchemy_conn</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sqlalchemy_engine_close</span><span class="p">()</span>
                <span class="n">df</span><span class="o">.</span><span class="n">to_sql</span><span class="p">(</span><span class="n">table_name</span><span class="p">,</span> <span class="n">sqlalchemy_conn</span><span class="p">,</span> <span class="n">schema</span><span class="o">=</span><span class="n">schema</span><span class="p">,</span> <span class="n">if_exists</span><span class="o">=</span><span class="s1">&#39;append&#39;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">chunksize</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sqlalchemy_engine_close</span><span class="p">()</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;truncate table </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">table_name_fqn</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">set_table_owner</span><span class="p">(</span><span class="n">table_name_fqn</span><span class="p">,</span> <span class="s1">&#39;operational_dba&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>  <span class="c1"># have to commit or we will lock this table</span>
                <span class="k">return</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Table exists&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Need Fully qualified table name&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span></div>

<div class="viewcode-block" id="Connection.check_table_exists"><a class="viewcode-back" href="../../api/py_dbutils.html#py_dbutils.dbconn.Connection.check_table_exists">[docs]</a>    <span class="k">def</span> <span class="nf">check_table_exists</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table_name_fqn</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Describe Method:</span>

<span class="sd">        Args:(self, table_name_fqn):</span>
<span class="sd">          table_name (str): String</span>

<span class="sd">        Returns:</span>
<span class="sd">          None: None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dbtype</span> <span class="o">==</span> <span class="s1">&#39;POSTGRES&#39;</span><span class="p">:</span>
            <span class="n">table_exists</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">sql</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;select count(*) from information_schema.tables</span>
<span class="s2">            WHERE table_type=&#39;BASE TABLE&#39;</span>
<span class="s2">            and table_name=&#39;</span><span class="si">{table_name}</span><span class="s2">&#39;</span>
<span class="s2">            &quot;&quot;&quot;</span>
            <span class="k">if</span> <span class="s1">&#39;.&#39;</span> <span class="ow">in</span> <span class="n">table_name_fqn</span><span class="p">:</span>
                <span class="n">table_name</span> <span class="o">=</span> <span class="n">table_name_fqn</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">schema</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot; and table_schema=&#39;</span><span class="si">{}</span><span class="s2">&#39;&quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">table_name_fqn</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>

                <span class="n">sql</span> <span class="o">=</span> <span class="n">sql</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">table_name</span><span class="o">=</span><span class="n">table_name</span><span class="p">,</span> <span class="n">schema</span><span class="o">=</span><span class="n">schema</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">sql</span> <span class="o">=</span> <span class="n">sql</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">table_name</span><span class="o">=</span><span class="n">table_name_fqn</span><span class="p">,</span> <span class="n">schema</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>

            <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_a_value</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">x</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">x</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;warning multiple tables found&#39;</span><span class="p">)</span>
                <span class="n">table_exists</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Not Supported&#39;</span><span class="p">)</span>
            <span class="k">raise</span>
        <span class="k">return</span> <span class="n">table_exists</span></div>

    <span class="c1"># copy using pyscopg to convert a dataframe to a file like object and pass it into pyscopg</span>
    <span class="c1"># this does not write to the file system but puts all the data into memory</span>
<div class="viewcode-block" id="Connection.copy_from_file"><a class="viewcode-back" href="../../api/py_dbutils.html#py_dbutils.dbconn.Connection.copy_from_file">[docs]</a>    <span class="k">def</span> <span class="nf">copy_from_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dataframe</span><span class="p">,</span> <span class="n">table_name_fqn</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf8&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Describe Method:</span>

<span class="sd">        Args:(self, dataframe, table_name_fqn, encoding=&#39;utf8&#39;):</span>
<span class="sd">          table_name (str): String</span>

<span class="sd">        Returns:</span>
<span class="sd">          None: None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">StringIO</span> <span class="k">import</span> <span class="n">StringIO</span>
        <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">io</span> <span class="k">import</span> <span class="n">StringIO</span>

        <span class="kn">from</span> <span class="nn">contextlib</span> <span class="k">import</span> <span class="n">contextmanager</span>

        <span class="nd">@contextmanager</span>
        <span class="k">def</span> <span class="nf">readStringIO</span><span class="p">():</span>

            <span class="sd">&quot;&quot;&quot;Describe Method:</span>

<span class="sd">            Args:():</span>
<span class="sd">              table_name (str): String</span>

<span class="sd">            Returns:</span>
<span class="sd">              None: None</span>
<span class="sd">            &quot;&quot;&quot;</span>
        <span class="c1"># from cStringIO import StringIO</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># make sure we are at the begining of the object/file</span>
            <span class="n">data_stringIO</span> <span class="o">=</span> <span class="n">StringIO</span><span class="p">()</span>
            <span class="n">dataframe</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">data_stringIO</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf8&#39;</span><span class="p">)</span>
            <span class="n">data_stringIO</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">yield</span> <span class="n">data_stringIO</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">data_stringIO</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

            <span class="c1"># print(&quot;copy_from_file:&quot;, table_name_fqn, len(dataframe))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">create_cur</span><span class="p">()</span>
        <span class="k">with</span> <span class="n">readStringIO</span><span class="p">()</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">column_list</span> <span class="o">=</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dataframe</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
            <span class="n">cmd_string</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;COPY </span><span class="si">{table}</span><span class="s2"> (</span><span class="si">{columns}</span><span class="s2">) FROM STDIN WITH (FORMAT CSV)&quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">table</span><span class="o">=</span><span class="n">table_name_fqn</span><span class="p">,</span>
                                                                                            <span class="n">columns</span><span class="o">=</span><span class="n">column_list</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;pyscopg:&quot;</span><span class="p">,</span> <span class="n">cmd_string</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">copy_expert</span><span class="p">(</span><span class="n">cmd_string</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span></div>


    <span class="c1"># still in the works</span>

<div class="viewcode-block" id="Connection.import_bulk_dataframe"><a class="viewcode-back" href="../../api/py_dbutils.html#py_dbutils.dbconn.Connection.import_bulk_dataframe">[docs]</a>    <span class="k">def</span> <span class="nf">import_bulk_dataframe</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dataframe</span><span class="p">,</span> <span class="n">table_name_fqn</span><span class="p">,</span> <span class="n">file_delimiter</span><span class="o">=</span><span class="s1">&#39;,&#39;</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf8&#39;</span><span class="p">,</span>
                              <span class="n">in_memory</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Describe Method:</span>

<span class="sd">        Args:(self, dataframe, table_name_fqn, file_delimiter=&#39;,&#39;, header=False, encoding=&#39;utf8&#39;,</span>
<span class="sd">          table_name (str): String</span>

<span class="sd">        Returns:</span>
<span class="sd">          None: None</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">tempfile</span> <span class="o">=</span> <span class="s1">&#39;./_tmp_bulk_import.csv&#39;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">in_memory</span><span class="p">:</span>
            <span class="n">dataframe</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">tempfile</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="n">encoding</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">import_file_client_side</span><span class="p">(</span><span class="n">full_file_path</span><span class="o">=</span><span class="n">tempfile</span><span class="p">,</span> <span class="n">table_name_fqn</span><span class="o">=</span><span class="n">table_name_fqn</span><span class="p">,</span>
                                         <span class="n">file_delimiter</span><span class="o">=</span><span class="n">file_delimiter</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="n">header</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="n">encoding</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># import w/out writing to a file just use available memory</span>
            <span class="kn">import</span> <span class="nn">subprocess</span>
            <span class="kn">import</span> <span class="nn">StringIO</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_save_environment_vars</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_replace_environment_vars</span><span class="p">()</span>
            <span class="n">data_stringIO</span> <span class="o">=</span> <span class="n">StringIO</span><span class="o">.</span><span class="n">StringIO</span><span class="p">()</span>

            <span class="n">dataframe</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">data_stringIO</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="n">encoding</span><span class="p">)</span>
            <span class="n">params</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;--dbname=</span><span class="si">{dbname}</span><span class="s2"> --host=</span><span class="si">{host}</span><span class="s2"> -c &quot;\copy </span><span class="si">{table_name}</span><span class="s2"></span>
<span class="s2">                FROM stdin with (format csv, delimiter &#39;</span><span class="si">{delimiter}</span><span class="s2">&#39;, HEADER </span><span class="si">{header}</span><span class="s2">, ENCODING &#39;</span><span class="si">{encoding}</span><span class="s2">&#39;)&quot; &quot;&quot;&quot;</span>
            <span class="n">command_text</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">table_name</span><span class="o">=</span><span class="n">table_name_fqn</span><span class="p">,</span>
                                         <span class="n">delimiter</span><span class="o">=</span><span class="n">file_delimiter</span><span class="p">,</span> <span class="n">dbname</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_database_name</span><span class="p">,</span>
                                         <span class="n">host</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_host</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="n">header</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="n">encoding</span><span class="p">)</span>
            <span class="c1"># print(data_stringIO.getvalue())</span>
            <span class="n">copy_cmd</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;\copy census.geoheader FROM stdin with (format csv, ENCODING &#39;</span><span class="si">{encoding}</span><span class="s2">&#39;)&quot;&quot;&quot;</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;in memory copy command&quot;</span><span class="p">)</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">((</span><span class="s1">&#39;/opt/edb/as10/bin/psql&#39;</span><span class="p">,</span>
                                  <span class="s2">&quot;--dbname=</span><span class="si">{dbname}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dbname</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_database_name</span><span class="p">),</span>
                                  <span class="s2">&quot;--host=</span><span class="si">{host}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_host</span><span class="p">),</span>
                                  <span class="s2">&quot;--username=</span><span class="si">{username}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_userid</span><span class="p">),</span>
                                  <span class="s2">&quot;--command=&quot;&quot;</span><span class="si">{cmd}</span><span class="s2">&quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cmd</span><span class="o">=</span><span class="n">copy_cmd</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">encoding</span><span class="o">=</span><span class="n">encoding</span><span class="p">))</span>
                                  <span class="p">),</span> <span class="n">env</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_environment_vars</span><span class="p">(),</span> <span class="n">stdin</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">)</span>
            <span class="n">output</span><span class="p">,</span> <span class="n">error</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">communicate</span><span class="p">(</span><span class="n">data_stringIO</span><span class="o">.</span><span class="n">getvalue</span><span class="p">())</span>
            <span class="k">if</span> <span class="n">output</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="n">error</span><span class="p">)</span>
                <span class="k">raise</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_restore_environment_vars</span><span class="p">()</span></div>


    <span class="c1"># uses pyscopg2 builtin copy commmand delivered with binary</span>

<div class="viewcode-block" id="Connection.import_pyscopg2_copy"><a class="viewcode-back" href="../../api/py_dbutils.html#py_dbutils.dbconn.Connection.import_pyscopg2_copy">[docs]</a>    <span class="k">def</span> <span class="nf">import_pyscopg2_copy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">full_file_path</span><span class="p">,</span> <span class="n">table_name_fqn</span><span class="p">,</span> <span class="n">file_delimiter</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Describe Method:</span>

<span class="sd">        Args:(self, full_file_path, table_name_fqn, file_delimiter):</span>
<span class="sd">          table_name (str): String</span>

<span class="sd">        Returns:</span>
<span class="sd">          None: None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">create_cur</span><span class="p">()</span>
        <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">full_file_path</span><span class="p">)</span>
        <span class="c1"># cur.copy_from(f, table_name_fqn, columns=(&#39;col1&#39;, &#39;col2&#39;), sep=&quot;,&quot;)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">copy_from</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">table_name_fqn</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;,&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">x</span></div>


    <span class="c1"># simple import using client side</span>
    <span class="c1"># this assumes the csv has data exactly in the same structure as the target table</span>
<div class="viewcode-block" id="Connection.import_file_client_side"><a class="viewcode-back" href="../../api/py_dbutils.html#py_dbutils.dbconn.Connection.import_file_client_side">[docs]</a>    <span class="k">def</span> <span class="nf">import_file_client_side</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">full_file_path</span><span class="p">,</span> <span class="n">table_name_fqn</span><span class="p">,</span> <span class="n">file_delimiter</span><span class="o">=</span><span class="s1">&#39;,&#39;</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf8&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Describe Method:</span>

<span class="sd">        Args:(self, full_file_path, table_name_fqn, file_delimiter=&#39;,&#39;, header=False,</span>
<span class="sd">          table_name (str): String</span>

<span class="sd">        Returns:</span>
<span class="sd">          None: None</span>
<span class="sd">        &quot;&quot;&quot;</span>


        <span class="bp">self</span><span class="o">.</span><span class="n">_save_environment_vars</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_replace_environment_vars</span><span class="p">()</span>
        <span class="n">copy_command_client_side</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;psql --dbname=</span><span class="si">{3}</span><span class="s2"> --host=</span><span class="si">{4}</span><span class="s2"> -c &quot;\copy </span><span class="si">{0}</span><span class="s2"> FROM &#39;</span><span class="si">{1}</span><span class="s2">&#39; with (format csv, delimiter &#39;</span><span class="si">{2}</span><span class="s2">&#39;, HEADER </span><span class="si">{5}</span><span class="s2">, ENCODING &#39;</span><span class="si">{6}</span><span class="s2">&#39;)&quot; &quot;&quot;&quot;</span>

        <span class="n">data_file</span> <span class="o">=</span> <span class="n">full_file_path</span>

        <span class="n">t</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>

        <span class="n">command_text</span> <span class="o">=</span> <span class="n">copy_command_client_side</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">table_name_fqn</span><span class="p">,</span> <span class="n">data_file</span><span class="p">,</span> <span class="n">file_delimiter</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_database_name</span><span class="p">,</span>
                                                       <span class="bp">self</span><span class="o">.</span><span class="n">_host</span><span class="p">,</span> <span class="n">header</span><span class="p">,</span> <span class="n">encoding</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Copy Command STARTED:</span><span class="si">{0}</span><span class="s2"> Time:</span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">table_name_fqn</span><span class="p">,</span> <span class="n">t</span><span class="p">))</span>
        <span class="n">error_code</span><span class="p">,</span> <span class="n">txt_out</span> <span class="o">=</span> <span class="n">commands</span><span class="o">.</span><span class="n">getstatusoutput</span><span class="p">(</span><span class="n">command_text</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Copy Command Completed:</span><span class="si">{0}</span><span class="s2"> Time:</span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">txt_out</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()))</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Total Time:</span><span class="si">{0}</span><span class="s2"> &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">-</span> <span class="n">t</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_restore_environment_vars</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">error_code</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">txt_out</span><span class="p">)</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">data_file</span><span class="p">)</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">error_code</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">Exception</span>

        <span class="n">i</span> <span class="o">=</span> <span class="n">txt_out</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Total Rows Loaded: </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>

        <span class="k">return</span> <span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span></div></div>
</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../index.html">py-dbutils</a></h1>








<h3>Navigation</h3>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../license.html">License</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../authors.html">Authors</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../changelog.html">Changelog</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api/modules.html">Module Reference</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../index.html">Documentation overview</a><ul>
  <li><a href="../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2019, hnguyen.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 2.0.1</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
    </div>

    

    
  </body>
</html>